<!doctype html>
<html>
    <head>
        <title>Graphviz.js Example</title>
        <!-- <script src="vis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.css" rel="stylesheet" type="text/css"> -->
        <style>
            #graph {
                width: 800px;
                height: 600px;
                border: 1px solid rgb(152, 152, 152);
            }
            textarea {
                resize: none;
            }
            .graph {
                overflow: scroll;
            }
        </style>
    </head>
    <body>
        <div id="graph" class="graph"></div>
        <textarea id="code" rows="10" cols="60" resize="none"></textarea>
        <button onclick="show()">Show</button>
        <script src="viz-standalone.js"></script>
        <script src="engine.js"></script>
        <script>
            function trace(root) {
                // builds a set of all nodes and edges in a graph
                let nodes = new Set();
                let edges = new Set();

                function build(v) {
                    if (!nodes.has(v)) {
                        nodes.add(v);
                        for (let child of v.prev) {
                            edges.add([child, v]);
                            build(child);
                        }
                    }
                }

                build(root);
                return [nodes, edges];
            }

            a = new Value(5.0);
            a.label = "a";
            b = new Value(2.0);
            b.label = "b";

            c = a.mult(b);
            c.label = "c";

            d = c.sub(b);
            d.label = "d";

            var [nodes, edges] = trace(d);

            const nods = Array.from(nodes);
            const edgs = Array.from(edges);

            var vv = "",
                pp = "",
                dd = "",
                counter = 0;

            let dot = `digraph {
                    graph [rankdir=LR];
                    node [shape=record];
                `;

            for (let n of nodes) {
                let uid = `node${n.label}`;
                // Create node with label and data
                dot += `"${uid}" [label=" ${n.label} | data ${n.data.toFixed(4)} | grad ${n.grad.toFixed(4)} "];\n`;
                if (n.op) {
                    // Create operation node
                    let opId = `op${n.label}${n.op}`;
                    dot += `"${opId}" [label="${n.op}", shape="circle"];\n`;
                    // Connect operation node to value node
                    dot += `"${opId}" -> "${uid}";\n`;
                }
            }

            for (let [n1, n2] of edges) {
                // Connect parent node to the operation node of the child node
                let n1Id = `node${n1.label}`;
                let n2OpId = `op${n2.label}${n2.op}`;
                dot += `"${n1Id}" -> "${n2OpId}";\n`;
            }

            dot += `}`;

            Viz.instance().then(function (viz) {
                var svg = viz.renderSVGElement(dot);

                document.getElementById("graph").appendChild(svg);
            });
            function show() {
                var code = document.getElementById("code").value;
                //var operations = code.replace(/\s+/g, " ").trim().split(";");
                //operations = operations.filter((element) => element !== "");
                //     var nodes = String(
                //         operations[0].replace(/\s+/g, " ").trim(), // remove extra spaces in string
                //     ).split("=");
                //     console.log(operations);
                //     console.log(operations.length);
                //     console.log(nodes[0], nodes[1]);
                console.log(code);
            }
        </script>
    </body>
</html>
